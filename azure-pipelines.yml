# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- second-edition

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    curl -H 'Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NDQ2MDc1LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0MDI4NzUsImlzcyI6ImdvcGFkZGxlIn0.IbsKjNjdT6CDdTr571pFfs1idQUB1YZyX8swvncgtvIq7wx0LPUvBnIfN8rANpLfjyQReNJfL4LMV6Q3moqjSiYi6fh78MfbxqdiXsv5GQI80BRpQBpqx5Was8n1sV8X6PCKK_Fq0j9VNB65vgTNxufzWcxDdYAPAq4HmaMk1bIpcV8Dlefe9lKuNr5hk5FHVL24J8NnzKhL26iz04WO7r1j9HeUhX7ZUjA0IUXTMSrq9UorYpX0qykbJwcDL9UPcosnK9QWKywtiWiyNXPhkfLanuls63a8J9c6WzUnBRCuxJUHLB_8sVSxtnzo673o0osokrW7xWOGaVo79BVcbA' -X POST -d '{"serviceID":"svcea2dbbaeece184c4685c81b6ca0bcb4cc1cd3","releaseID":"rel9ca949ceecgc0e42cbe8008eedb7d80f1f2","distributionID":"dis6da49651eea97k4befea60be93d2989ea3c"}' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/build > buildinfo.json
    buildid="$(cat buildinfo.json | jq -r '.buildID')"
    buildVersion="$(cat buildinfo.json | jq -r '.buildVersion')"
    for (( ; ; )); do   curl -H 'Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NDQ2MDc1LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0MDI4NzUsImlzcyI6ImdvcGFkZGxlIn0.IbsKjNjdT6CDdTr571pFfs1idQUB1YZyX8swvncgtvIq7wx0LPUvBnIfN8rANpLfjyQReNJfL4LMV6Q3moqjSiYi6fh78MfbxqdiXsv5GQI80BRpQBpqx5Was8n1sV8X6PCKK_Fq0j9VNB65vgTNxufzWcxDdYAPAq4HmaMk1bIpcV8Dlefe9lKuNr5hk5FHVL24J8NnzKhL26iz04WO7r1j9HeUhX7ZUjA0IUXTMSrq9UorYpX0qykbJwcDL9UPcosnK9QWKywtiWiyNXPhkfLanuls63a8J9c6WzUnBRCuxJUHLB_8sVSxtnzo673o0osokrW7xWOGaVo79BVcbA' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/build/$buildid > buildstatusinfo.json;   buildstatus="$(cat buildstatusinfo.json | jq -r '.status')";   echo "$buildstatus";   if [[ $buildstatus == "Failed" ]];   then     echo "build failed";     break;   elif [[ $buildstatus == "Created" ]];   then     echo "build Created successfully";     echo "trigger rolling update";     curl -H 'Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NDQ2MDc1LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0MDI4NzUsImlzcyI6ImdvcGFkZGxlIn0.IbsKjNjdT6CDdTr571pFfs1idQUB1YZyX8swvncgtvIq7wx0LPUvBnIfN8rANpLfjyQReNJfL4LMV6Q3moqjSiYi6fh78MfbxqdiXsv5GQI80BRpQBpqx5Was8n1sV8X6PCKK_Fq0j9VNB65vgTNxufzWcxDdYAPAq4HmaMk1bIpcV8Dlefe9lKuNr5hk5FHVL24J8NnzKhL26iz04WO7r1j9HeUhX7ZUjA0IUXTMSrq9UorYpX0qykbJwcDL9UPcosnK9QWKywtiWiyNXPhkfLanuls63a8J9c6WzUnBRCuxJUHLB_8sVSxtnzo673o0osokrW7xWOGaVo79BVcbA' -X PUT -d '{"serviceGroups":[{"services":[{"id":"svcea2dbbaeece184c4685c81b6ca0bcb4cc1cd3","serviceVersion":"draft","releaseConfig":{"buildID":"$buildid","version":"$buildVersion"}}],"id":"sg0df64b22sg4999sg4388sg83e4sgaf6a58a03623","name":"mern-social","version":"draft","description":"dGVzdA=="}],"deploymentTemplateVersion":"draft","updateType":"buildUpdate"}' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/application/appsaba26100c2de1c4715c802ac14d9d85fc2e8 > rollingupdateinfo.json;     rollingUpdateMessage="$(cat rollingupdateinfo.json | jq -r '.message')";     cat rollingupdateinfo.json;     echo "$rollingUpdateMessage";     break;   elif [[ $buildstatus == "Creating" ]];   then     echo "build creating...";     continue;   else     echo "unknown status build dropped";     break;   fi; done
  displayName: 'Build And Rolling Update'
