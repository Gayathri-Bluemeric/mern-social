# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- second-edition

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    curl -H 'Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NTM1OTE4LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0OTI3MTgsImlzcyI6ImdvcGFkZGxlIn0.v4nk0Qx7XrM3tDfN_sZpAdgTfH_JgZS_EUo5tf95WSGxvBDsxBpqfPLPEvwOZiPt1MR9LnRGcqddlwMyENduBlo5QSv2fbqNHZWFikJELI0k3-r_IcWwlt6o75HSCf0fWuddmCzr5U_AX68UkWKSW3aYcKUujh9bEhfOImSbB4C8YQLED_R_x4w21XvvovInkWg2yDANRQ5VJ4xnVNH2y81gN5tDZCqSUEjK6SQSvapOGbJ58jPRQ3PAeSZvJJhH8gvx6L2-bUL6oX59L31xaJZtb5R1O7MiYwUJDEv182kapRTc1uhdE8I0KqhzKdTbt50DJx7aBXijNMUJyynR1w' -X POST -d '{"serviceID":"svceacb48302cb661c4384caec3c980d5d3736e8","releaseID":"rel9ca949ceecgc0e42cbe8008eedb7d80f1f2","distributionID":"dis6da49651eea97k4befea60be93d2989ea3c"}' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/build > buildinfo.json    buildid="$(cat buildinfo.json | jq -r '.buildID')"
    buildVersion="$(cat buildinfo.json | jq -r '.buildVersion')"
    for (( ; ; )); do   curl -H 'Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NTM1OTE4LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0OTI3MTgsImlzcyI6ImdvcGFkZGxlIn0.v4nk0Qx7XrM3tDfN_sZpAdgTfH_JgZS_EUo5tf95WSGxvBDsxBpqfPLPEvwOZiPt1MR9LnRGcqddlwMyENduBlo5QSv2fbqNHZWFikJELI0k3-r_IcWwlt6o75HSCf0fWuddmCzr5U_AX68UkWKSW3aYcKUujh9bEhfOImSbB4C8YQLED_R_x4w21XvvovInkWg2yDANRQ5VJ4xnVNH2y81gN5tDZCqSUEjK6SQSvapOGbJ58jPRQ3PAeSZvJJhH8gvx6L2-bUL6oX59L31xaJZtb5R1O7MiYwUJDEv182kapRTc1uhdE8I0KqhzKdTbt50DJx7aBXijNMUJyynR1w' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/build/$buildid > buildstatusinfo.json;   buildstatus="$(cat buildstatusinfo.json | jq -r '.status')";   echo "$buildstatus";   if [[ $buildstatus == "Failed" ]];   then     echo "build failed";     break;   elif [[ $buildstatus == "Created" ]];   then     echo "build Created successfully";     echo "trigger rolling update";     curl -H 'Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJkZW1vQGdvcGFkZGxlLmlvIiwiZXhwIjoxNjM1NTM1OTE4LCJqdGkiOiI1MzMxZTc3MGc0N2U4ZzRiNDlnYjQxMmdkZWNiYmMyOGRmNWUiLCJpYXQiOjE2MzU0OTI3MTgsImlzcyI6ImdvcGFkZGxlIn0.v4nk0Qx7XrM3tDfN_sZpAdgTfH_JgZS_EUo5tf95WSGxvBDsxBpqfPLPEvwOZiPt1MR9LnRGcqddlwMyENduBlo5QSv2fbqNHZWFikJELI0k3-r_IcWwlt6o75HSCf0fWuddmCzr5U_AX68UkWKSW3aYcKUujh9bEhfOImSbB4C8YQLED_R_x4w21XvvovInkWg2yDANRQ5VJ4xnVNH2y81gN5tDZCqSUEjK6SQSvapOGbJ58jPRQ3PAeSZvJJhH8gvx6L2-bUL6oX59L31xaJZtb5R1O7MiYwUJDEv182kapRTc1uhdE8I0KqhzKdTbt50DJx7aBXijNMUJyynR1w' -X PUT -d '{"serviceGroups":[{"services":[{"id":"svcea2dbbaeece184c4685c81b6ca0bcb4cc1cd3","serviceVersion":"draft","releaseConfig":{"buildID":"$buildid","version":"$buildVersion"}}],"id":"sg0df64b22sg4999sg4388sg83e4sgaf6a58a03623","name":"mern-social","version":"draft","description":"dGVzdA=="}],"deploymentTemplateVersion":"draft","updateType":"buildUpdate"}' https://beta.gopaddle.io/gateway/v1/prj8adfc684ef68be4feeea67be271e9f2b32d5/application/appsa1d92252c0211c4226c81a4c5bccde8cc421 > rollingupdateinfo.json;     rollingUpdateMessage="$(cat rollingupdateinfo.json | jq -r '.message')";     cat rollingupdateinfo.json;     echo "$rollingUpdateMessage";     break;   elif [[ $buildstatus == "Creating" ]];   then     echo "build creating...";     continue;   else     echo "unknown status build dropped";     break;   fi; done
  displayName: 'Build And Rolling Update the application'
